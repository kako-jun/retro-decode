# RetroDecode — 1ピクセルずつ、過去を保存 (P⁴)

## プロジェクト概要

**RetroDecode** は、日本のレトロビジュアルノベルの画像デコード処理を解析・可視化する教育ツールです。歴史的な暗号化技術をインタラクティブな段階的可視化で実演します。

**キャッチフレーズ**: "Pixel by pixel, past preserved" （1ピクセルずつ、過去を保存）  
**略称**: P⁴ (4つのP: Pixel, by, Pixel, Past, Preserved)

## 目的と法的遵守

- **教育目的**: レトロゲームで使用された暗号化技術の研究
- **歴史保存**: 古いメモリ最適化手法（リングバッファなど）の理解
- **インタラクティブ学習**: デコード過程の段階的可視化
- **法的遵守**: ユーザー所有のファイル処理のみ、著作権侵害なし
- **往復検証**: デコード→エンコード→比較による実装完全性確認

## 🚧 現在の実装状況（2025年7月3日更新）

### ✅ 実装済み機能
- **LF2デコード**: ToHeart LF2形式の読み込み・LZSS展開
- **PDTデコード**: Kanon PDT形式の読み込み
- **透過PNG出力**: アルファチャンネル対応PNG生成
- **マルチフォーマット出力**: BMP, PNG, RAW RGB/RGBA
- **CLI設計**: --input, --output, --format分離アーキテクチャ
- **バッチ処理**: --input-dir での一括処理
- **ベンチマーク**: --benchmark での構造化出力
- **テスト生成**: 合成テストファイル自動生成
- **往復テスト基盤**: roundtrip_test.rs実装済み
- **LF2エンコード**: 実装済み（100%ピクセル精度達成）
  - 往復テスト完全成功：64,525ピクセル全て一致
  - 現在は全ダイレクトモード（マッチング無効化）
  - 圧縮率：237.7%（オリジナル33.4%に対し低効率）
- **技術知見記録**: 体系的技術文書作成完了（4ファイルに分離）

### 🔬 進行中の重要研究
- **LF2完全解析プロジェクト**: 20年前の開発者思考の逆エンジニアリング
  - 現状：99.7%ピクセル精度（173/64525差異）、ファイルサイズ198.9%
  - 課題：第2決定から完全分岐（オリジナル18バイトマッチ vs 我々直接ピクセル）
  - 発見：リングバッファ初期状態解釈の根本的差異
- **機械学習エンコーダ研究**: 300+LF2ファイルからパターン学習
  - GPU環境準備済み、PyTorch実装設計完了
  - 目標：ブラックボックス→解釈可能な決定ルール抽出

### ❌ 未実装機能（重要）
- **PDTエンコード**: RGB画像 → PDT形式書き込み（機械学習手法適用予定）
- **写真からの変換**: 大きな写真 → LF2/PDT変換
- **LF2完全一致エンコーダ**: 100%ピクセル精度のLZSS実装

## 🎯 直近のTODO

### 🚀 革新的アプローチ: 機械学習による失われた技術復元
1. **LF2機械学習エンコーダ**: 300+ファイルから開発者の決定パターンを学習
   - 特徴量：リングバッファ状態、ピクセル文脈、位置情報、利用可能マッチ
   - 目標：ブラックボックス学習→人間解釈可能ルール変換
   - 教育価値：「機械学習でレトロゲームエンコーダを復元」という画期的手法
2. **PDT機械学習準備**: LF2で構築したノウハウをPDTに適用
3. **ハイブリッド戦略**: 人間の推理 + 機械学習検証

### 従来アプローチ（継続）
- **人間による逆エンジニアリング**: 第2決定分岐問題の解決
- **リングバッファ初期状態**: 0x20埋め、0x0fee開始位置の再検証

### 今週の革新目標
- 機械学習環境構築とLF2学習データセット準備
- 300+ファイル決定シーケンス抽出と特徴量設計
- 第1回学習実験とパターン発見
- 人間解釈可能な決定ルール抽出手法開発

## 🚀 アーキテクチャ概要

### 技術スタック
- **コア処理**: Rust（主要）、Python、TypeScript  
- **機械学習**: PyTorch、CUDA、GPU加速（新規追加）
- **GUI**: Tauri + Web技術（計画中）
- **CLI**: Rust（単体バイナリ配布）
- **可視化**: HTML5 Canvas、WebGL（計画中）

### 🧠 機械学習パイプライン設計
1. **データ収集**: 300+ LF2ファイル → 約1000万決定ポイント
2. **特徴抽出**: 
   - リングバッファ状態（32バイト履歴）
   - ピクセル文脈（9x9周辺パターン）  
   - 画像内位置（正規化X,Y座標）
   - 利用可能マッチ候補（距離・長さ分布）
3. **学習目標**: 
   - 決定タイプ予測（直接 vs マッチ）
   - マッチパラメータ予測（位置・長さ）
4. **解釈手法**:
   - 注意機構による重要特徴可視化
   - 決定木による人間解釈可能ルール抽出
   - SHAP値による特徴寄与度分析

### サポート対象ゲーム形式
- **ToHeartシリーズ**: PAK ✅, LF2 ✅, SCN ⚠️
- **Kanonシリーズ**: PDT ✅, G00 ⚠️
- **痕（Kizuato）**: ToHeartと同形式（確認中）

## 📋 ツール利用情報

### 主要コマンド
```bash
# デコード（拡張子で自動判定）
retro-decode --input file.lf2 --output result.png
retro-decode --input file.pdt --output result.png

# 往復テスト
cargo test roundtrip

# ベンチマーク
retro-decode --benchmark --input file.lf2
```

### 開発ツール
- **Rust**: `cargo build`, `cargo test`
- **Git**: 進捗追跡とコミット
- **エディタ**: VSCode/Claude Codeで開発

## 📚 技術文書体系

### 文書構成
1. **`.claude/CLAUDE.md`** (本ファイル) - プロジェクト管理・進捗追跡・ツール情報
2. **[TECHNICAL_INSIGHTS.md](.claude/TECHNICAL_INSIGHTS.md)** - 設計思想・実装パターン・アーキテクチャ
3. **[LF2_COMPRESSION_ANALYSIS.md](.claude/LF2_COMPRESSION_ANALYSIS.md)** - LF2圧縮解析・性能比較データ
4. **[PDT_KNOWLEDGE.md](.claude/PDT_KNOWLEDGE.md)** - PDT形式解析・実装知見
5. **[PROJECT_ROADMAP.md](.claude/PROJECT_ROADMAP.md)** - 長期実装計画・ディレクトリ整理計画
6. **[REFERENCES.md](.claude/REFERENCES.md)** - 参考資料・既存ツール・ゲームデータ情報
7. **[DEVELOPMENT_GUIDE.md](.claude/DEVELOPMENT_GUIDE.md)** - 葉鍵ベンチ・テスト戦略・開発ノート

### 文書活用方針
- **開発作業時**: 本ファイルで現在の状況とTODO確認
- **技術実装時**: TECHNICAL_INSIGHTSで設計パターン参照
- **LF2最適化時**: LF2_COMPRESSION_ANALYSISで目標値確認
- **PDT実装時**: PDT_KNOWLEDGEで仕様詳細確認

## 📈 進捗追跡

### 最新マイルストーン
- **✅ 2025年7月2日完了**: LF2エンコード機能実装完了
- **✅ 2025年7月3日完了**: 技術文書体系整理完了
- **🎯 2025年7月9日目標**: LF2圧縮最適化（マッチング機能実装）
- **2025年7月16日目標**: PDTエンコード機能実装完了

---

**P⁴ — 1ピクセルずつ、過去を保存**

*限られたハードウェアでビジュアルストーリーテリングを実現した巧妙な圧縮技術を探求*