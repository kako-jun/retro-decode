# PDT形式知見文書

## 概要

Kanon PDT形式の解析結果と実装知見。Ver1とVer2の違い、デコード・エンコード実装のポイントを記録。

## PDT形式の基本構造

### ヘッダ情報
- **マジックナンバー**: 形式識別子
- **バージョン情報**: Ver1/Ver2の区別
- **画像寸法**: 幅・高さピクセル
- **色情報**: パレット色数、色深度

### データセクション
1. **パレットデータ**: RGB色情報
2. **圧縮画像データ**: RLE等で圧縮されたピクセル
3. **メタデータ**: 付加情報（透過色等）

## バージョン別差異

### Ver1 特徴
- **シンプル構造**: 基本的なRLE圧縮
- **固定パレット**: 256色固定
- **直接色指定**: インデックス値がそのまま色番号

### Ver2 特徴  
- **拡張ヘッダ**: より多くのメタデータ
- **可変パレット**: 実際の使用色数に最適化
- **圧縮改良**: より効率的な符号化

## 実装済み機能

### デコード処理
- ✅ **ヘッダ解析**: 両バージョン対応
- ✅ **パレット展開**: RGB値への変換
- ✅ **RLE展開**: 圧縮データの復元
- ✅ **透過処理**: アルファチャンネル生成

### 出力フォーマット
- ✅ **PNG出力**: 透過対応
- ✅ **BMP出力**: 標準形式
- ✅ **RAW出力**: デバッグ用

## 未実装機能

### エンコード処理
- ❌ **PNG→PDT変換**: 任意画像からPDT生成
- ❌ **パレット最適化**: 使用色数の自動調整
- ❌ **RLE圧縮**: エンコード時の圧縮処理
- ❌ **バージョン選択**: Ver1/Ver2出力切り替え

### 高度機能
- ❌ **色減少**: フルカラー→パレット変換
- ❌ **ディザリング**: 色数制限時の品質向上
- ❌ **透過色自動検出**: 背景色の自動判定

## 技術実装メモ

### RLE圧縮の詳細
```rust
// RLEエンコードパターン
// 同じ値がN回続く場合: [制御バイト][値][回数]
// 直接値の場合: [値]

pub fn decode_rle(data: &[u8]) -> Result<Vec<u8>, Error> {
    let mut output = Vec::new();
    let mut i = 0;
    
    while i < data.len() {
        let control = data[i];
        if control & 0x80 != 0 {
            // 圧縮データ
            let count = (control & 0x7F) + 1;
            let value = data[i + 1];
            output.extend(vec![value; count as usize]);
            i += 2;
        } else {
            // 直接データ
            output.push(control);
            i += 1;
        }
    }
    
    Ok(output)
}
```

### パレット処理
- **色順序**: BGR vs RGB の注意
- **透過処理**: 特定インデックスの透過化
- **色精度**: 8ビット精度の維持

## 開発優先度

### Phase 1: エンコード基盤
- **目標**: PNG→PDT基本変換
- **期間**: 1週間
- **成果物**: 往復テスト成功

### Phase 2: 最適化機能
- **目標**: 色減少・パレット最適化
- **期間**: 1週間  
- **成果物**: 写真からの高品質変換

### Phase 3: 高度機能
- **目標**: ディザリング・透過検出
- **期間**: 数日
- **成果物**: 完全な写真変換パイプライン

## テスト戦略

### 既存ファイルテスト
- Kanonゲームファイルでの往復検証
- 視覚的品質の確認
- バイナリレベルでの一致検証

### 合成ファイルテスト  
- 人工的なPDTファイル生成
- 境界値テスト（1x1, 最大サイズ等）
- エラーケースの検証

### パフォーマンステスト
- 大容量ファイルでの処理時間
- メモリ使用量の測定
- 他形式との比較評価

## 知られている制限事項

### 現在の制限
- エンコード機能完全未実装
- Ver1/Ver2自動判別の精度問題
- 一部の変則的なPDTファイル未対応

### 技術的制約
- パレットサイズの固定制限
- RLE効率の改善余地
- 透過色検出の精度向上必要

## 参考情報

### 既存ツール
- `p2b_000s`: 参照実装
- 過去のTypeScript実装
- 解析.xlsx の関連データ

### テストデータ
- Windows95版Kanon画像ファイル
- Windows2000版Kanon画像ファイル
- 人工生成テストファイル

### 関連技術
- BMP形式仕様
- PNG透過処理
- 色量子化アルゴリズム