# LF2圧縮解析レポート

## 概要

ToHeartのLF2形式圧縮技術の詳細解析データと性能比較。本文書は実装最適化のための具体的目標値を提供する。

## 現在の実装状況

### 往復テスト結果（2025年7月2日）
- **ピクセル精度**: 100%（64,525ピクセル全一致）
- **機能完成度**: デコード・エンコード基本機能完成
- **圧縮効率**: 大幅改善の余地あり

### 圧縮効率比較

| 実装方式 | 圧縮率 | ファイルサイズ | 効率比 |
|----------|--------|----------------|--------|
| オリジナル | 33.4% | 86,183 bytes | 基準 |
| 現在実装 | 237.7% | 613,248 bytes | 0.14x |
| **改善目標** | **35-60%** | **90,000-155,000 bytes** | **4-7x** |

### 詳細解析データ

#### オリジナル実装の特徴
- **高度なマッチング処理**: LZSS辞書検索最適化
- **効率的フラグビット配置**: 8ビット単位での圧縮制御
- **座標変換**: Y-flip処理による画像データ最適化

#### 現在実装の問題点
- **全ダイレクトモード**: マッチング機能未実装
- **非効率なフラグビット使用**: 圧縮機会を逃している
- **辞書検索未最適化**: 基本的なスライディングウィンドウのみ

## 最適化ロードマップ

### Phase 1: マッチング機能実装
- **目標圧縮率**: 100-150%（現在の237.7%から改善）
- **実装内容**: 基本的なLZSS辞書検索
- **期間**: 2-3日

### Phase 2: 高度マッチング最適化
- **目標圧縮率**: 50-80%（オリジナルレベル接近）
- **実装内容**: 
  - 最長一致検索アルゴリズム
  - ハッシュテーブル最適化
  - 閾値調整
- **期間**: 1週間

### Phase 3: 圧縮率極限追求
- **目標圧縮率**: 33-40%（オリジナル同等）
- **実装内容**:
  - 圧縮パラメータファインチューニング
  - 画像特性に応じた最適化
  - メモリ使用量最適化

## ベンチマーク基準値

### テストファイル詳細
- **解像度**: 337×191ピクセル
- **色深度**: 8ビットパレット
- **元画像サイズ**: 約196KB（非圧縮想定）
- **実際ファイルサイズ**: 86,183 bytes

### 目標性能指標
- **圧縮時間**: <100ms（現在実装基準）
- **メモリ使用量**: <10MB（辞書サイズ含む）
- **往復精度**: 100%維持必須

## 技術実装メモ

### LZSS実装キーポイント
1. **辞書サイズ**: 4096バイト（12ビット）
2. **最小マッチ長**: 3バイト
3. **最大マッチ長**: 18バイト（4+14ビット）
4. **フラグビット**: 8回に1回配置

### 座標変換処理
- **Y-flip**: `y_flipped = height - 1 - y`
- **インデックス計算**: `idx = y_flipped * width + x`
- **透過処理**: アルファチャンネル対応必須

### 既知の実装課題
- エンコード時のマッチング処理未実装
- 圧縮効率測定の自動化不足
- 大容量ファイルでのメモリ使用量未検証

## 参考データ

### 圧縮効率向上による影響
- **3.4倍改善時**: 613KB → 180KB（60%削減）
- **5.8倍改善時**: 613KB → 106KB（83%削減）
- **オリジナル同等時**: 613KB → 86KB（86%削減）

### 実装優先度
1. **🔴 緊急**: マッチング機能基本実装
2. **🟡 高**: 辞書検索最適化
3. **🟢 中**: パフォーマンスチューニング